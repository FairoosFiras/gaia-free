name: Fork CI Trigger

# This workflow allows maintainers to run CI on fork PRs by commenting "/run-ci"
# It copies the fork's branch to an internal branch where CI can run with secrets

on:
  issue_comment:
    types: [created]

jobs:
  trigger-ci:
    # Only run on PR comments (not issue comments) with "/run-ci" from maintainers
    if: |
      github.event.issue.pull_request &&
      contains(github.event.comment.body, '/run-ci') &&
      (
        github.event.comment.author_association == 'OWNER' ||
        github.event.comment.author_association == 'MEMBER' ||
        github.event.comment.author_association == 'COLLABORATOR'
      )
    runs-on: ubuntu-latest
    steps:
      - name: Get PR details
        id: pr
        uses: actions/github-script@v7
        with:
          script: |
            const pr = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number
            });

            const isFork = pr.data.head.repo.full_name !== pr.data.base.repo.full_name;

            core.setOutput('is_fork', isFork);
            core.setOutput('head_repo', pr.data.head.repo.full_name);
            core.setOutput('head_ref', pr.data.head.ref);
            core.setOutput('head_sha', pr.data.head.sha);
            core.setOutput('pr_number', context.issue.number);

            // Add reaction to acknowledge the command
            await github.rest.reactions.createForIssueComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: context.payload.comment.id,
              content: 'rocket'
            });

      - name: Checkout base repo
        if: steps.pr.outputs.is_fork == 'true'
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.PAT }}
          fetch-depth: 0

      - name: Fetch and push fork branch
        if: steps.pr.outputs.is_fork == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Add fork as remote and fetch the PR branch
          git remote add fork https://github.com/${{ steps.pr.outputs.head_repo }}.git
          git fetch fork ${{ steps.pr.outputs.head_ref }}

          # Create/update internal branch for CI
          INTERNAL_BRANCH="ci/pr-${{ steps.pr.outputs.pr_number }}"
          git checkout -B "${INTERNAL_BRANCH}" FETCH_HEAD

          # Push to trigger CI (force push to update if branch exists)
          git push -f origin "${INTERNAL_BRANCH}"

          echo "Pushed to ${INTERNAL_BRANCH}"

      - name: Comment on PR
        if: steps.pr.outputs.is_fork == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = ${{ steps.pr.outputs.pr_number }};
            const internalBranch = `ci/pr-${prNumber}`;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: `ðŸš€ CI triggered! Running tests on internal branch \`${internalBranch}\`.\n\nCheck the [Actions tab](https://github.com/${context.repo.owner}/${context.repo.repo}/actions) for progress.`
            });

      - name: Skip for non-fork PRs
        if: steps.pr.outputs.is_fork == 'false'
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: 'âœ… This PR is from the main repo, CI runs automatically. No need for `/run-ci`.'
            });
